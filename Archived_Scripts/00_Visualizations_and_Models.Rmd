---
title: "00_Visualizations_and_Models"
output: html_document
date: "2024-11-09"
---

This document will walk through some initial plots of raw data, followed by model construction

# Data Background:
There are 10 dataframes that will be used in this process, which are created in the source file "01_Data_Imput"
Two dataframes hold weekly data from 1982 - 2024, two hold imputed weekly data from 1982 - 2024, two that hold the weekly data that is trimmed to 2014 - 2023, two that hold the imputed data from 2014 - 2023, and two hold daily data from 2014 - 2023.
There are two of each of these dataframes because one is trimmed to only include April 1 - July 15 each year, and the other is un-trimmed. Models will be built with the trimmed data in order for the relationship between flow and ice presence to be correct.
Training models will be built using data from 2014-2023, these are the years in which in-situ ice observations are available.
```{r echo = FALSE}
# load libraries
library(pacman)
p_load(dplyr,dataRetrieval,lubridate,tidyr,ggplot2,viridis,readxl,imputeTS,tsibble,sjPlot,pROC,gridExtra,broom,gtsummary)
# This is the file that combines and cleans data:
source("Input_Files/01_Data_Input.R")

# Un-comment a dataframe to view:
## these three are the un-trimmed data
#daily:
#View(flow_temp_cond_daily_ice)
# weekly:
#View(flow_temp_cond_weekly_ice)
# weekly imputed:
#View(flow_temp_cond_imputed_ice)

## these are the trimmed data:
# daily:
#View(daily_data_trimmed)
# weekly:
#View(weekly_data_trimmed)
# weekly imputed:
#View(imputed_data_trimmed)

# weekly trimmed for 2014-2023:
#View(flow_temp_cond_weekly_ice_14_23)
# weekly trimmed 2014-2023 and trimmed for spring:
#View(weekly_data_trimmed_14_23)
# weekly imputed trimmed for 2014-2023
#View(flow_temp_cond_imputed_ice_14_23)
# weekly imputed trimmed for 2014-2023 and trimmed for spring:
#View(imputed_data_trimmed_14_23)
```
## Visualizations:
Let's look at some of the raw data:

First, let's look at the observed dates of ice-off by year (±6 days) obtained from photos taken by field crews:
```{r}
obs_ice_off_plot <- ggplot(obs_ice_off_dates, aes(x = waterYear, y = wy_doy_ice_off)) +
  geom_point() +
  geom_smooth()+
  scale_x_continuous(
    breaks = seq(min(obs_ice_off_dates$waterYear), max(obs_ice_off_dates$waterYear), by = 1))+
  labs(
    title = "Observed Date of Ice-Off 2013-2023",
    x = "Year",
    y = "Water Year DOY of Ice-Off (± 6d)")
obs_ice_off_plot
```

Here's a low-resolution look at the cumulative flow for each year in which we have in-situ ice observations. Visually, between the water year day of year 200 - 250, flow usually begins to increase.
```{r echo=FALSE}
ggplot(flow_temp_cond_daily_ice %>% filter(waterYear >= 2014 & waterYear < 2024), aes(x = wy_doy, y = cumulative_dis))+
  geom_line() +  # Use geom_point() if you prefer points instead of lines
  facet_wrap(~ waterYear) +  # Creates a separate plot for each water year
  labs(
    title = "Cumulative Discharge (cfs)",
    x = "Water Year Day of Year",
    y = "Cumulative Discharge") 
```
Now let's take a closer look at each year and compare the cumulative discharge to ice observations - the shaded area of each plot represents the observed time of ice beginning to melt to when there is 0 ice on The Loch.

Visually, the variability in each year is not too high, but probably high enough that a model only using cumulative discharge would not be accurate for predicting ice-off.
```{r echo = FALSE}
# water year 2014
ggplot(
  flow_temp_cond_daily_ice %>%
    filter(waterYear == 2014),
  aes(x = wy_doy, y = cumulative_dis, group = waterYear)) +
  geom_rect(aes(xmin=205,xmax=247,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  geom_line() +
  lims(x = c(200, 260), y = c(150, 750))+
  labs(x = "Water Year Day of Year (2014)", y = "Cumulative Discharge (cfs)")+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
```
2015:
```{r echo = FALSE}
# water year 2015:
ggplot(
  flow_temp_cond_daily_ice %>%
    filter(waterYear == 2015),
  aes(x = wy_doy, y = cumulative_dis, group = waterYear)) +
  geom_rect(aes(xmin=197,xmax=239,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  geom_line() +
  lims(x = c(180, 260), y = c(130, 600))+
  labs(x = "Water Year Day of Year (2015)", y = "Cumulative Discharge (cfs)")+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
```
2016:
```{r echo = FALSE}
# water year 2016:
ggplot(
  flow_temp_cond_daily_ice %>%
    filter(waterYear == 2016),
  aes(x = wy_doy, y = cumulative_dis, group = waterYear)) +
  geom_rect(aes(xmin=195,xmax=251,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  geom_line() +
  lims(x = c(180, 260), y = c(50, 700))+
  labs(x = "Water Year Day of Year (2016)", y = "Cumulative Discharge (cfs)")+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
```
2017:
```{r echo = FALSE}
# water year 2017:
ggplot(
  flow_temp_cond_daily_ice %>%
    filter(waterYear == 2017),
  aes(x = wy_doy, y = cumulative_dis, group = waterYear)) +
  geom_rect(aes(xmin=173,xmax=243,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  geom_line() +
  lims(x = c(170, 255), y = c(50, 600))+
  labs(x = "Water Year Day of Year (2017)", y = "Cumulative Discharge (cfs)")+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
```
2018:
```{r echo = FALSE}
# water year 2018:
ggplot(
  flow_temp_cond_daily_ice %>%
    filter(waterYear == 2018),
  aes(x = wy_doy, y = cumulative_dis, group = waterYear)) +
  geom_rect(aes(xmin=214,xmax=235,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  geom_line() +
  lims(x = c(210, 240), y = c(180, 750))+
  labs(x = "Water Year Day of Year (2018)", y = "Cumulative Discharge (cfs)")+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
```
2019:
```{r echo = FALSE}
# water year 2019:
ggplot(
  flow_temp_cond_daily_ice %>%
    filter(waterYear == 2019),
  aes(x = wy_doy, y = cumulative_dis, group = waterYear)) +
  geom_rect(aes(xmin=206,xmax=260,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  geom_line() +
  lims(x = c(200, 270), y = c(180, 1000))+
  labs(x = "Water Year Day of Year (2019)", y = "Cumulative Discharge (cfs)")+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
```
2020:
```{r echo=FALSE}
# water year 2020:
ggplot(
  flow_temp_cond_daily_ice %>%
    filter(waterYear == 2020),
  aes(x = wy_doy, y = cumulative_dis, group = waterYear)) +
  geom_rect(aes(xmin=211,xmax=234,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  geom_line() +
  lims(x = c(200, 250), y = c(50, 450))+
  labs(x = "Water Year Day of Year (2020)", y = "Cumulative Discharge (cfs)")+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
```
2021:
```{r echo=FALSE}
# water year 2021
ggplot(
  flow_temp_cond_daily_ice %>%
    filter(waterYear == 2021),
  aes(x = wy_doy, y = cumulative_dis, group = waterYear)) +
  geom_rect(aes(xmin=210,xmax=255,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  geom_line() +
  lims(x = c(200, 270), y = c(50, 900))+
  labs(x = "Water Year Day of Year (2021)", y = "Cumulative Discharge (cfs)")+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
```
2022:
```{r echo=FALSE}
# water year 2022
ggplot(
  flow_temp_cond_daily_ice %>%
    filter(waterYear == 2022),
  aes(x = wy_doy, y = cumulative_dis, group = waterYear)) +
  geom_rect(aes(xmin=216,xmax=244,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  geom_line() +
  lims(x = c(200, 250), y = c(50, 450))+
  labs(x = "Water Year Day of Year (2022)", y = "Cumulative Discharge (cfs)")+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
```
2023:
```{r echo=FALSE}
# water year 2023:
ggplot(
  flow_temp_cond_daily_ice %>%
    filter(waterYear == 2023),
  aes(x = wy_doy, y = cumulative_dis, group = waterYear)) +
  geom_rect(aes(xmin=215,xmax=243,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  geom_line() +
  lims(x = c(205, 250), y = c(70, 600))+
  labs(x = "Water Year Day of Year (2023)", y = "Cumulative Discharge (cfs)")+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
```
Now let's look at the daily observations of temperature and conductivity by year compared to the date of 0 ice on The Loch (represented by a vertical black line).

Visually, temperature and conductivity seem to have less variation year-to-year.
```{r}
# making a long format dataframe to visualize the two variables together.
out_condTempDaily_long <- pivot_longer(out_cond_temp_daily, -c(Date,wy_doy,waterYear), names_to="hydro_variables", values_to = "temp_or_cond") %>% mutate(waterYear = calcWaterYear(Date)) %>% mutate(Date = as.Date(Date, tz = "MST", format = "%Y-%m-%d"))%>% mutate(wy_doy = hydro.day(Date))
```
Every year:
```{r}

ggplot(out_condTempDaily_long %>% filter(waterYear >= 2014 & waterYear <=2023), aes(wy_doy,temp_or_cond, group = waterYear, col = hydro_variables)) + geom_point(size = 0.5) + labs(x = "Water Year Day of Year", y = "Temperature (C), Conductivity (uS/cm)")+facet_wrap(~ waterYear)

```

# Temp and Cond
2014:
```{r echo=FALSE}
# water year 2014
ggplot(out_condTempDaily_long %>% filter(waterYear==2014), aes(wy_doy,temp_or_cond, group = waterYear, col = hydro_variables)) + geom_point(size = 0.5) + labs(x = "Water Year Day of Year (2014)", y = "Temperature (C), Conductivity (uS/cm)")+ geom_vline(xintercept = 247) # ice off date
```
2015:
```{r echo=FALSE}
# water year 2015
ggplot(out_condTempDaily_long %>% filter(waterYear==2015), aes(wy_doy,temp_or_cond, group = waterYear, col = hydro_variables)) + geom_point(size = 0.5) + labs(x = "Water Year Day of Year (2015)", y = "Temperature (C), Conductivity (uS/cm)")+ geom_vline(xintercept = 239) # ice off date
```
2016:
```{r echo=FALSE}
# water year 2016
ggplot(out_condTempDaily_long %>% filter(waterYear==2016), aes(wy_doy,temp_or_cond, group = waterYear, col = hydro_variables)) + geom_point(size = 0.5) + labs(x = "Water Year Day of Year (2016)", y = "Temperature (C), Conductivity (uS/cm)")+ geom_vline(xintercept = 251) # ice off date
```
2017:
```{r echo=FALSE}
# water year 2017
ggplot(out_condTempDaily_long %>% filter(waterYear==2017), aes(wy_doy,temp_or_cond, group = waterYear, col = hydro_variables)) + geom_point(size = 0.5) + labs(x = "Water Year Day of Year (2017)", y = "Temperature (C), Conductivity (uS/cm)")+ geom_vline(xintercept = 243) # ice off date
```
2018:
```{r echo=FALSE}
# water year 2018
ggplot(out_condTempDaily_long %>% filter(waterYear==2018), aes(wy_doy,temp_or_cond, group = waterYear, col = hydro_variables)) + geom_point(size = 0.5) + labs(x = "Water Year Day of Year (2018)", y = "Temperature (C), Conductivity (uS/cm)")+ geom_vline(xintercept = 235) # ice off date
```
2019:
```{r echo=FALSE}
# water year 2019
ggplot(out_condTempDaily_long %>% filter(waterYear==2019), aes(wy_doy,temp_or_cond, group = waterYear, col = hydro_variables)) + geom_point(size = 0.5) + labs(x = "Water Year Day of Year (2019)", y = "Temperature (C), Conductivity (uS/cm)")+ geom_vline(xintercept = 260) # ice off date
```
2020:
```{r echo=FALSE}
# water year 2020
ggplot(out_condTempDaily_long %>% filter(waterYear==2020), aes(wy_doy,temp_or_cond, group = waterYear, col = hydro_variables)) + geom_point(size = 0.5) + labs(x = "Water Year Day of Year (2020)", y = "Temperature (C), Conductivity (uS/cm)")+ geom_vline(xintercept = 234) # ice off date
```
2021:
```{r echo=FALSE}
# water year 2021
ggplot(out_condTempDaily_long %>% filter(waterYear==2021), aes(wy_doy,temp_or_cond, group = waterYear, col = hydro_variables)) + geom_point(size = 0.5) + labs(x = "Water Year Day of Year (2021)", y = "Temperature (C), Conductivity (uS/cm)")+ geom_vline(xintercept = 255) # ice off date
```
2022:
```{r echo=FALSE}
# water year 2022
ggplot(out_condTempDaily_long %>% filter(waterYear==2022), aes(wy_doy,temp_or_cond, group = waterYear, col = hydro_variables)) + geom_point(size = 0.5) + labs(x = "Water Year Day of Year (2022)", y = "Temperature (C), Conductivity (uS/cm)")+ geom_vline(xintercept = 244) # ice off date
```
2023:
```{r echo=FALSE}
# water year 2023
ggplot(out_condTempDaily_long %>% filter(waterYear==2023), aes(wy_doy,temp_or_cond, group = waterYear, col = hydro_variables)) + geom_point(size = 0.5) + labs(x = "Water Year Day of Year (2023)", y = "Temperature (C), Conductivity (uS/cm)")+ geom_vline(xintercept = 243) # ice off date
```
# Models:
Here we start to make simple binary logistic regression models with different variables and compare their accuracy.

April 1 - July 15 Trimmed vs. Un-Trimmed Data - all variables:
These models take into account all the variables: temperature, conductivity, flow, cumulative discharge, and water year.
```{r}
# untrimmed data:
untrimmed_daily_all <- glm(ice_presence~Flow+cumulative_dis+Temperature_C+cond_uScm+waterYear, data = flow_temp_cond_daily_ice, family = binomial)

untrimmed_weekly_all <- glm(ice_presence~Flow+cumulative_dis+temperature_C_raw+cond_uScm+waterYear, data = flow_temp_cond_weekly_ice_14_23, family = binomial)

untrimmed_imputed_all <- glm(ice_presence~Flow+cumulative_dis+temperature_C_impute+cond_uScm_impute+waterYear, data = flow_temp_cond_imputed_ice_14_23, family = binomial)

# trimmed data:
trimmed_daily_all <- glm(ice_presence~Flow+cumulative_dis+Temperature_C+cond_uScm+waterYear, data = daily_data_trimmed, family = binomial)

trimmed_weekly_all <- glm(ice_presence~Flow+cumulative_dis+temperature_C_raw+cond_uScm+waterYear, data = weekly_data_trimmed_14_23, family = binomial)

trimmed_imputed_all <- glm(ice_presence~Flow+cumulative_dis+temperature_C_impute+cond_uScm_impute+waterYear, data = imputed_data_trimmed_14_23, family = binomial)

```
How do they compare?
The R^2 for the models using data trimmed to include only April 1 - July 15 increase by ~ 0.2 for each different temporal frequency. So from now on, we will be using the trimmed data.
```{r}
tab_model(untrimmed_daily_all,untrimmed_weekly_all,untrimmed_imputed_all,trimmed_daily_all,trimmed_imputed_all,trimmed_weekly_all,
  show.ci = FALSE, # remove CI
  show.aic = TRUE, # display AIC
  p.style = "numeric_stars" # display p-values and stars
)
```
Now that we know to use the trimmed data, we'll narrow down the variables used in the model. We'll start by removing flow because we have cumulative discharge had a lower p-value in the trimmed models.
```{r}
trimmed_daily_reduced1 <- glm(ice_presence~cumulative_dis+Temperature_C+cond_uScm+waterYear, data = daily_data_trimmed, family = binomial)

trimmed_weekly_reduced1 <- glm(ice_presence~cumulative_dis+temperature_C_raw+cond_uScm+waterYear, data = weekly_data_trimmed_14_23, family = binomial)

trimmed_imputed_reduced1 <- glm(ice_presence~cumulative_dis+temperature_C_impute+cond_uScm_impute+waterYear, data = imputed_data_trimmed_14_23, family = binomial)
```
Results: <0.01 change in R^2
```{r}
tab_model(trimmed_daily_reduced1, trimmed_imputed_reduced1,trimmed_weekly_reduced1, trimmed_daily_all,trimmed_imputed_all,trimmed_weekly_all,
  show.ci = FALSE, # remove CI
  show.aic = TRUE, # display AIC
  p.style = "numeric_stars" # display p-values and stars
)
```
Now we'll remove water year because it was not significant in any of the reduced models.
```{r}
trimmed_daily_reduced2 <- glm(ice_presence~cumulative_dis+Temperature_C+cond_uScm, data = daily_data_trimmed, family = binomial)

trimmed_weekly_reduced2 <- glm(ice_presence~cumulative_dis+temperature_C_raw+cond_uScm, data = weekly_data_trimmed_14_23, family = binomial)

trimmed_imputed_reduced2 <- glm(ice_presence~cumulative_dis+temperature_C_impute+cond_uScm_impute, data = imputed_data_trimmed_14_23, family = binomial)
```
Results: No change in R^2
```{r}
tab_model(trimmed_daily_reduced2, trimmed_imputed_reduced2,trimmed_weekly_reduced2, trimmed_daily_reduced1,trimmed_imputed_reduced1,trimmed_weekly_reduced1,
  show.ci = FALSE, # remove CI
  show.aic = TRUE, # display AIC
  p.style = "numeric_stars" # display p-values and stars
)
```
Now we'll remove conductivity because its p-value was only <0.05 in one model
```{r}
trimmed_daily_reduced_final <- glm(ice_presence~cumulative_dis+Temperature_C, data = daily_data_trimmed, family = binomial)

trimmed_weekly_reduced_final <- glm(ice_presence~cumulative_dis+temperature_C_raw, data = weekly_data_trimmed_14_23, family = binomial)

trimmed_imputed_reduced_final <- glm(ice_presence~cumulative_dis+temperature_C_impute, data = imputed_data_trimmed_14_23, family = binomial)
```
Results: -0.011 change for weekly R^2, <0.01 change in daily and imputed R^2
```{r}
tab_model(trimmed_daily_reduced_final, trimmed_imputed_reduced_final,trimmed_weekly_reduced_final, trimmed_daily_reduced2,trimmed_imputed_reduced2,trimmed_weekly_reduced2,
  show.ci = FALSE, # remove CI
  show.aic = TRUE, # display AIC
  p.style = "numeric_stars" # display p-values and stars
)
```

Now that we have models that explain ~86% of the data (imputed model), we'll make some plots to determine the thresholds at which the models should determine ice-off.
```{r}
discharge_plot <- plot_model(trimmed_imputed_reduced_final,
  type = "pred",
  terms = c("cumulative_dis [all]"),
  ci.lvl = NA # remove confidence bands
) +
  labs(y = "Prob (no ice)")

temp_plot <- plot_model(trimmed_imputed_reduced_final,
  type = "pred",
  terms = c("temperature_C_impute [all]"),
  ci.lvl = NA # remove confidence bands
) +
  labs(y = "Prob (no ice)")

discharge_plot
temp_plot
```
## Plotting Probability
Now we'll plot the probability of ice as a function of time.
Here we make a new data frame with the imputed values, and add the probability of ice presence given by the model
```{r echo=FALSE}
# probabilities_impute <- predict(trimmed_imputed_reduced_final, type = "response")
# 
# imputed_data_trimmed_prob <- imputed_data_trimmed
# imputed_data_trimmed_prob$ice_probability <- probabilities_impute
# this is giving a list of probabilities - predict with (data frame water year and wy_doy)
# then merge these together. This will produce a lot of NAs but that's okay

# this was daily predicted values before I changed it to imputed for meeting
```
2014:
```{r echo=FALSE}

plot2014 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2014), aes(x = wy_doy, y = ice_probability)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=205,xmax=247,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  labs(title = "Predicted Probability of Ice Over Time",x = "Water Year Day of Year",y = "Probability of Ice")+ 
  theme_dark()+
  lims(x = c(200,265))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

plot2014_2 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2014), aes(x = wy_doy, y = cumulative_dis)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=205,xmax=247,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  labs(
    title = "Cumulative Discharge Over Time",
    x = "Water Year Day of Year",
    y = "Cumulative Discharge (cfs)")+ lims(x = c(200,265)) + 
    theme_dark()+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
grid.arrange(plot2014, plot2014_2, ncol = 1)
```
2015:
```{r echo=FALSE}

plot2015 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2015), aes(x = wy_doy, y = ice_probability)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=197,xmax=239,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  labs(
    title = "Predicted Probability of Ice Over Time",
    x = "Water Year Day of Year",
    y = "Probability of Ice"
  )+ lims(x = c(195,265))+
  theme_dark()+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

plot2015_2 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2015), aes(x = wy_doy, y = cumulative_dis)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=197,xmax=239,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  labs(
    title = "Cumulative Discharge Over Time",
    x = "Water Year Day of Year",
    y = "Cumulative Discharge (cfs)") + 
    lims(x = c(195,265))+
    theme_dark()+
    theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

grid.arrange(plot2015, plot2015_2, ncol = 1)
```
2016:
```{r echo=FALSE}

plot2016 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2016), aes(x = wy_doy, y = ice_probability)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=195,xmax=251,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  labs(
    title = "Predicted Probability of Ice Over Time",
    x = "Water Year Day of Year",
    y = "Probability of Ice"
  )+ lims(x = c(190,270))+
  theme_dark()+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

plot2016_2 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2016), aes(x = wy_doy, y = cumulative_dis)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=195,xmax=251,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  labs(
    title = "Cumulative Discharge Over Time",
    x = "Water Year Day of Year",
    y = "Cumulative Discharge (cfs)"
  ) + lims(x = c(190,270))+
  theme_dark()+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

grid.arrange(plot2016, plot2016_2, ncol = 1)
```
2017:
```{r fig.height}

plot2017 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2017), aes(x = wy_doy, y = ice_probability)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=173,xmax=243,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  labs(
    title = "Predicted Probability of Ice Over Time",
    x = "Water Year Day of Year",
    y = "Probability of Ice"
  )+ lims(x = c(170,260))+
  theme_dark()+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

plot2017_2 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2017), aes(x = wy_doy, y = cumulative_dis)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=173,xmax=243,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  labs(
    title = "Cumulative Discharge Over Time",
    x = "Water Year Day of Year",
    y = "Cumulative Discharge (cfs)"
  )+ lims(x = c(170,260)) +
  theme_dark()+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

grid.arrange(plot2017, plot2017_2, ncol = 1)
```
2018:
```{r echo=FALSE}

plot2018 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2018), aes(x = wy_doy, y = ice_probability)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=214,xmax=235,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Predicted Probability of Ice Over Time",
    x = "Water Year Day of Year",
    y = "Probability of Ice"
  )+ lims(x = c(200,250))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

plot2018_2 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2018), aes(x = wy_doy, y = cumulative_dis)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=214,xmax=235,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Cumulative Discharge Over Time",
    x = "Water Year Day of Year",
    y = "Cumulative Discharge (cfs)"
  ) + lims(x = c(200,250))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

grid.arrange(plot2018, plot2018_2, ncol = 1)
```
2019:
```{r echo=FALSE}

plot2019 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2019), aes(x = wy_doy, y = ice_probability)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=206,xmax=260,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Predicted Probability of Ice Over Time",
    x = "Water Year Day of Year",
    y = "Probability of Ice"
  )+ lims(x = c(200,270))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
plot2019_2 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2019), aes(x = wy_doy, y = cumulative_dis)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=206,xmax=260,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Cumulative Discharge Over Time",
    x = "Water Year Day of Year",
    y = "Cumulative Discharge (cfs)"
  ) + lims(x = c(200,270))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
grid.arrange(plot2019, plot2019_2, ncol = 1)
```
2020:
```{r echo=FALSE}

plot2020 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2020), aes(x = wy_doy, y = ice_probability)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=211,xmax=234,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Predicted Probability of Ice Over Time",
    x = "Water Year Day of Year",
    y = "Probability of Ice"
  )+ lims(x = c(200,250))+ 
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
plot2020_2 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2020), aes(x = wy_doy, y = cumulative_dis)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=211,xmax=234,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Cumulative Discharge Over Time",
    x = "Water Year Day of Year",
    y = "Cumulative Discharge (cfs)"
  ) + lims(x = c(200,250))+ 
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
grid.arrange(plot2020, plot2020_2, ncol = 1)
```
2021:
```{r echo=FALSE}

plot2021 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2021), aes(x = wy_doy, y = ice_probability)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=210,xmax=255,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Predicted Probability of Ice Over Time",
    x = "Water Year Day of Year",
    y = "Probability of Ice"
  )+ lims(x = c(200,270))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

plot2021_2 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2021), aes(x = wy_doy, y = cumulative_dis)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=210,xmax=255,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Cumulative Discharge Over Time",
    x = "Water Year Day of Year",
    y = "Cumulative Discharge (cfs)"
  ) + lims(x = c(200,270))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
grid.arrange(plot2021, plot2021_2, ncol = 1)
```
2022:
```{r echo=FALSE}

plot2022 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2022), aes(x = wy_doy, y = ice_probability)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=216,xmax=244,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Predicted Probability of Ice Over Time",
    x = "Water Year Day of Year",
    y = "Probability of Ice"
  )+ lims(x = c(210,270))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

plot2022_2 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2022), aes(x = wy_doy, y = cumulative_dis)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=216,xmax=244,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Cumulative Discharge Over Time",
    x = "Water Year Day of Year",
    y = "Cumulative Discharge (cfs)"
  ) + lims(x = c(210,270))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
grid.arrange(plot2022, plot2022_2, ncol = 1)
```
2023:
```{r echo=FALSE}

plot2023 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2023), aes(x = wy_doy, y = ice_probability)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=215,xmax=243,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Predicted Probability of Ice Over Time",
    x = "Water Year Day of Year",
    y = "Probability of Ice"
  )+ lims(x = c(210,260))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

plot2023_2 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2023), aes(x = wy_doy, y = cumulative_dis)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=215,xmax=243,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Cumulative Discharge Over Time",
    x = "Water Year Day of Year",
    y = "Cumulative Discharge (cfs)"
  ) + lims(x = c(210,260))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

grid.arrange(plot2023, plot2023_2, ncol = 1)
```
Temperature and Probability of Ice:
2014:
```{r echo=FALSE}

plot2014_3 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2014), aes(x = wy_doy, y = Temperature_C)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=205,xmax=247,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark()+
  labs(
    title = "Temperature Over Time",
    x = "Water Year Day of Year",
    y = "Temperature (C)"
  ) + lims(x = c(200,265))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
grid.arrange(plot2014,plot2014_3, ncol = 1)
```
2015:
```{r echo=FALSE}

plot2015_3 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2015), aes(x = wy_doy, y = Temperature_C)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=197,xmax=239,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark()+
  labs(
    title = "Temperature Over Time",
    x = "Water Year Day of Year",
    y = "Temperature (C)"
  ) + lims(x = c(195,265))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
grid.arrange(plot2015, plot2015_3, ncol = 1)
```
2016:
```{r echo=FALSE}

plot2016_3 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2016), aes(x = wy_doy, y = Temperature_C)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=195,xmax=251,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark()+
  labs(
    title = "Temperature Over Time",
    x = "Water Year Day of Year",
    y = "Temperature (C)"
  ) + lims(x = c(190,270))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
grid.arrange(plot2016, plot2016_3, ncol = 1)
```
2017:
```{r echo=FALSE}

plot2017_3 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2017), aes(x = wy_doy, y = Temperature_C)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=173,xmax=243,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark()+
  labs(
    title = "Temperature Over Time",
    x = "Water Year Day of Year",
    y = "Temperature (C)"
  ) + lims(x = c(170,260))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
grid.arrange(plot2017, plot2017_3, ncol = 1)
```
2018:
```{r echo=FALSE}

plot2018_3 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2018), aes(x = wy_doy, y = Temperature_C)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=214,xmax=235,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Temperature Over Time",
    x = "Water Year Day of Year",
    y = "Temperature (C)"
  ) + lims(x = c(200,250))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
grid.arrange(plot2018, plot2018_3, ncol = 1)
```
2019:
```{r echo=FALSE}

plot2019_3 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2019), aes(x = wy_doy, y = Temperature_C)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=206,xmax=260,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Temperature Over Time",
    x = "Water Year Day of Year",
    y = "Temperature (C)"
  )+ lims(x = c(200,270)) +
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
grid.arrange(plot2019, plot2019_3, ncol = 1)
```
2020:
```{r echo=FALSE}

plot2020_3 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2020), aes(x = wy_doy, y = Temperature_C)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=211,xmax=234,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Temperature Over Time",
    x = "Water Year Day of Year",
    y = "Temperature (C)"
  ) + lims(x = c(200,250))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
grid.arrange(plot2020, plot2020_3, ncol = 1)
```
2021:
```{r echo=FALSE}

plot2021_3 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2021), aes(x = wy_doy, y = Temperature_C)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=210,xmax=255,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Temperature Over Time",
    x = "Water Year Day of Year",
    y = "Temperature (C)"
  ) + lims(x = c(200,270))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
grid.arrange(plot2021, plot2021_3, ncol = 1)
```
2022:
```{r echo=FALSE}

plot2022_3 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2022), aes(x = wy_doy, y = Temperature_C)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=216,xmax=244,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Temperature Over Time",
    x = "Water Year Day of Year",
    y = "Temperature (C)"
  )+ lims(x = c(210,270)) +
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
grid.arrange(plot2022, plot2022_3, ncol = 1)
```
2023:
```{r echo=FALSE}

plot2023_3 <- ggplot(daily_data_trimmed_prob %>% filter(waterYear == 2023), aes(x = wy_doy, y = Temperature_C)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=215,xmax=243,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Temperature Over Time",
    x = "Water Year Day of Year",
    y = "Temperature (C)"
  ) + lims(x = c(210,260))+ 
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
grid.arrange(plot2023, plot2023_3, ncol = 1)
```


# Cumulative Temp
```{r}
# daily:
cumulative_temp_daily <- group_by(flow_temp_cond_daily_ice, waterYear) %>%
  mutate(cumulative_temp = cumsum(Temperature_C), 
         wy_doy = seq(1:n()))
# daily trimmed:
## 2014-2023
daily_data_trimmed_cumulTemp <- filter_by_year_and_doy(cumulative_temp_daily, c(170,288)) # March 18 - July 15

```
## Models with cumulative temp:
```{r}
daily_cumulTemp_model <- glm(ice_presence~cumulative_dis+cumulative_temp, data = daily_data_trimmed_cumulTemp, family = binomial)


tab_model(trimmed_daily_reduced_final, trimmed_imputed_reduced_final,trimmed_weekly_reduced_final, daily_cumulTemp_model,
  show.ci = FALSE, # remove CI
  show.aic = TRUE, # display AIC
  p.style = "numeric_stars" # display p-values and stars
)
```
Adding Probability from cumul temp to df
```{r}
probabilities_cumulTemp <- predict(daily_cumulTemp_model, type = "response")

cumul_Temp_dat_trim_Prob <- daily_data_trimmed_cumulTemp
cumul_Temp_dat_trim_Prob$ice_probability <- probabilities_cumulTemp
```
Plotting probability with cumulative temp:
### 2014
```{r}
plot2014_cumulTemp <- ggplot(cumul_Temp_dat_trim_Prob %>% filter(waterYear == 2014), aes(x = wy_doy, y = ice_probability)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=205,xmax=247,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  labs(title = "Predicted Probability of Ice Over Time",x = "Water Year Day of Year",y = "Probability of Ice")+ 
  theme_dark()+
  lims(x = c(200,265))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

plot2014_cumulTemp_2 <- ggplot(cumul_Temp_dat_trim_Prob %>% filter(waterYear == 2014), aes(x = wy_doy, y = cumulative_temp)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=205,xmax=247,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  labs(
    title = "Cumulative Temperature Over Time",
    x = "Water Year Day of Year",
    y = "Cumulative Temperature (C)")+ lims(x = c(200,265)) + 
    theme_dark()+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
grid.arrange(plot2014_cumulTemp, plot2014_cumulTemp_2, ncol = 1)
```
### 2015:
```{r}
plot2015_cumulTemp <- ggplot(cumul_Temp_dat_trim_Prob %>% filter(waterYear == 2015), aes(x = wy_doy, y = ice_probability)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=197,xmax=239,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  labs(
    title = "Predicted Probability of Ice Over Time",
    x = "Water Year Day of Year",
    y = "Probability of Ice"
  )+ lims(x = c(195,265))+
  theme_dark()+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

plot2015_cumulTemp_2 <- ggplot(cumul_Temp_dat_trim_Prob %>% filter(waterYear == 2015), aes(x = wy_doy, y = cumulative_temp)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=197,xmax=239,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  labs(
    title = "Cumulative Temperature Over Time",
    x = "Water Year Day of Year",
    y = "Cumulative Temperature (C)") + 
    lims(x = c(195,265))+
    theme_dark()+
    theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

grid.arrange(plot2015_cumulTemp, plot2015_cumulTemp_2, ncol = 1)
```
### 2016:
```{r}
plot2016_cumulTemp <- ggplot(cumul_Temp_dat_trim_Prob %>% filter(waterYear == 2016), aes(x = wy_doy, y = ice_probability)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=195,xmax=251,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  labs(
    title = "Predicted Probability of Ice Over Time",
    x = "Water Year Day of Year",
    y = "Probability of Ice"
  )+ lims(x = c(190,270))+
  theme_dark()+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

plot2016_cumulTemp_2 <- ggplot(cumul_Temp_dat_trim_Prob %>% filter(waterYear == 2016), aes(x = wy_doy, y = cumulative_temp)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=195,xmax=251,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  labs(
    title = "Cumulative Temperature Over Time",
    x = "Water Year Day of Year",
    y = "Cumulative Temperature (C)"
  ) + lims(x = c(190,270))+
  theme_dark()+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

grid.arrange(plot2016_cumulTemp, plot2016_cumulTemp_2, ncol = 1)
```
### 2017:
```{r}
plot2017_cumulTemp <- ggplot(cumul_Temp_dat_trim_Prob %>% filter(waterYear == 2017), aes(x = wy_doy, y = ice_probability)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=173,xmax=243,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  labs(
    title = "Predicted Probability of Ice Over Time",
    x = "Water Year Day of Year",
    y = "Probability of Ice"
  )+ lims(x = c(170,260))+
  theme_dark()+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

plot2017_cumulTemp_2 <- ggplot(cumul_Temp_dat_trim_Prob %>% filter(waterYear == 2017), aes(x = wy_doy, y = cumulative_temp)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=173,xmax=243,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  labs(
    title = "Cumulative Temperature Over Time",
    x = "Water Year Day of Year",
    y = "Cumulative Temperature(C)"
  )+ lims(x = c(170,260)) +
  theme_dark()+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

grid.arrange(plot2017_cumulTemp, plot2017_cumulTemp_2, ncol = 1)
```
### 2018:
```{r}
plot2018_cumulTemp <- ggplot(cumul_Temp_dat_trim_Prob %>% filter(waterYear == 2018), aes(x = wy_doy, y = ice_probability)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=214,xmax=235,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Predicted Probability of Ice Over Time",
    x = "Water Year Day of Year",
    y = "Probability of Ice"
  )+ lims(x = c(200,250))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

plot2018_cumulTemp_2 <- ggplot(cumul_Temp_dat_trim_Prob %>% filter(waterYear == 2018), aes(x = wy_doy, y = cumulative_temp)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=214,xmax=235,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Cumulative Temperature Over Time",
    x = "Water Year Day of Year",
    y = "Cumulative Temperature(C)"
  ) + lims(x = c(200,250))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

grid.arrange(plot2018_cumulTemp, plot2018_cumulTemp_2, ncol = 1)
```
### 2019:
```{r}
plot2019_cumulTemp <- ggplot(cumul_Temp_dat_trim_Prob %>% filter(waterYear == 2019), aes(x = wy_doy, y = ice_probability)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=206,xmax=260,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Predicted Probability of Ice Over Time",
    x = "Water Year Day of Year",
    y = "Probability of Ice"
  )+ lims(x = c(200,270))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
plot2019_cumulTemp_2 <- ggplot(cumul_Temp_dat_trim_Prob %>% filter(waterYear == 2019), aes(x = wy_doy, y = cumulative_temp)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=206,xmax=260,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Cumulative Temperature Over Time",
    x = "Water Year Day of Year",
    y = "Cumulative Temperature (C)"
  ) + lims(x = c(200,270))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
grid.arrange(plot2019_cumulTemp, plot2019_cumulTemp_2, ncol = 1)
```
### 2020:
```{r}
plot2020_cumulTemp <- ggplot(cumul_Temp_dat_trim_Prob %>% filter(waterYear == 2020), aes(x = wy_doy, y = ice_probability)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=211,xmax=234,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Predicted Probability of Ice Over Time",
    x = "Water Year Day of Year",
    y = "Probability of Ice"
  )+ lims(x = c(200,250))+ 
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
plot2020_cumulTemp_2 <- ggplot(cumul_Temp_dat_trim_Prob %>% filter(waterYear == 2020), aes(x = wy_doy, y = cumulative_temp)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=211,xmax=234,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Cumulative Temperature Over Time",
    x = "Water Year Day of Year",
    y = "Cumulative Temperature (C)"
  ) + lims(x = c(200,250))+ 
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
grid.arrange(plot2020_cumulTemp, plot2020_cumulTemp_2, ncol = 1)
```
### 2021:
```{r}
plot2021_cumulTemp <- ggplot(cumul_Temp_dat_trim_Prob %>% filter(waterYear == 2021), aes(x = wy_doy, y = ice_probability)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=210,xmax=255,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Predicted Probability of Ice Over Time",
    x = "Water Year Day of Year",
    y = "Probability of Ice"
  )+ lims(x = c(200,270))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

plot2021_cumulTemp_2 <- ggplot(cumul_Temp_dat_trim_Prob %>% filter(waterYear == 2021), aes(x = wy_doy, y = cumulative_temp)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=210,xmax=255,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Cumulative Temperature Over Time",
    x = "Water Year Day of Year",
    y = "Cumulative Temperature (C)"
  ) + lims(x = c(200,270))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
grid.arrange(plot2021_cumulTemp, plot2021_cumulTemp_2, ncol = 1)
```
### 2022:
```{r}
plot2022_cumulTemp <- ggplot(cumul_Temp_dat_trim_Prob %>% filter(waterYear == 2022), aes(x = wy_doy, y = ice_probability)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=216,xmax=244,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Predicted Probability of Ice Over Time",
    x = "Water Year Day of Year",
    y = "Probability of Ice"
  )+ lims(x = c(210,270))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

plot2022_cumulTemp_2 <- ggplot(cumul_Temp_dat_trim_Prob %>% filter(waterYear == 2022), aes(x = wy_doy, y = cumulative_temp)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=216,xmax=244,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Cumulative Temperature Over Time",
    x = "Water Year Day of Year",
    y = "Cumulative Temperature (C)"
  ) + lims(x = c(210,270))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))
grid.arrange(plot2022_cumulTemp, plot2022_cumulTemp_2, ncol = 1)
```
### 2023:
```{r}
plot2023_cumulTemp <- ggplot(cumul_Temp_dat_trim_Prob %>% filter(waterYear == 2023), aes(x = wy_doy, y = ice_probability)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=215,xmax=243,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Predicted Probability of Ice Over Time",
    x = "Water Year Day of Year",
    y = "Probability of Ice"
  )+ lims(x = c(210,260))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

plot2023_cumulTemp_2 <- ggplot(cumul_Temp_dat_trim_Prob %>% filter(waterYear == 2023), aes(x = wy_doy, y = cumulative_temp)) +
  geom_line(color = "blue") +
  geom_rect(aes(xmin=215,xmax=243,ymin=-Inf,ymax=Inf), fill="lightblue",alpha=0.01)+
  theme_dark() +
  labs(
    title = "Cumulative Temperature Over Time",
    x = "Water Year Day of Year",
    y = "Cumulative Temperature (C)"
  ) + lims(x = c(210,260))+
  theme(panel.ontop=TRUE,panel.background = element_rect(fill = NA))

grid.arrange(plot2023_cumulTemp, plot2023_cumulTemp_2, ncol = 1)
```
# Average Probability in Observed Windows Cumul Temp:
## Extracting only observations in ice windows (cumul temp):
```{r}
# Sample function to extract ice_probability between wy_doy_100_ice and wy_doy_0_ice
extract_ice_probability <- function(cumul_Temp_dat_trim_Prob, obs_ice_melt_windows) {
  
  # Initialize an empty list to store the results
  result_list <- list()
  
  # Loop through each unique waterYear in the observation data
  for (year in unique(obs_ice_melt_windows$waterYear)) {
    
    # Get the doy range for the current waterYear
    doy_100 <- obs_ice_melt_windows$wy_doy_100_ice[obs_ice_melt_windows$waterYear == year]
    doy_0 <- obs_ice_melt_windows$wy_doy_0_ice[obs_ice_melt_windows$waterYear == year]
    
    # Subset the cumul_Temp_dat_trim_Prob data frame for the current year
    temp_data <- cumul_Temp_dat_trim_Prob[cumul_Temp_dat_trim_Prob$waterYear == year, ]
    
    # Filter the rows where wy_doy is between wy_doy_100_ice and wy_doy_0_ice
    filtered_data <- temp_data[temp_data$wy_doy >= doy_100 & temp_data$wy_doy <= doy_0, ]
    
    # Store the filtered data in the result list
    result_list[[as.character(year)]] <- filtered_data
  }
  
  # Combine all the filtered data frames into one
  result_df <- do.call(rbind, result_list)
  
  return(result_df)
}

# Example usage
result_df <- extract_ice_probability(cumul_Temp_dat_trim_Prob, obs_ice_melt_windows)

# View the result
View(result_df)
```
## Average of Ice Probability for each year (cumul temp):
```{r}
averageProbabilityDF_cumulTemp <- group_by(result_df, waterYear) %>%
  mutate(average_prob = mean(ice_probability))
meanAllYears_cumulTemp <- mean(averageProbabilityDF_cumulTemp$average_prob)
```
## Graph average probability by year (cumul temp):
```{r}
ggplot(averageProbabilityDF_cumulTemp, aes(x = waterYear, y = average_prob)) +
  geom_point(color = "red") +         # Add points for each year
  labs(title = "Average Ice Probability Over Time",
       x = "Year",
       y = "Average Ice Probability")
```
## Average Ice Probability over all years (cumulative temp):
```{r}
print(meanAllYears_cumulTemp)
```
# Average Probability in Observed Windows (daily temp):
```{r}
# Filtering data with daily temps for observed windows:
result_daily_df <- extract_ice_probability(daily_data_trimmed_prob, obs_ice_melt_windows)

# View the result
View(result_daily_df)
```
## Average probability within the windows by year for daily temp:
```{r}
averageProbabilityDF_dailyTemp <- group_by(result_daily_df, waterYear) %>%
  mutate(average_prob = mean(ice_probability))
meanAllYears_dailyTemp <- mean(averageProbabilityDF_dailyTemp$average_prob)
```
## Graph average probability by year for daily temp:
```{r}
ggplot(averageProbabilityDF_dailyTemp, aes(x = waterYear, y = average_prob)) +
  geom_point(color = "red") + 
  labs(title = "Average Ice Probability Over Time",
       x = "Year",
       y = "Average Ice Probability")
```
## Average Ice Probability over all years (cumulative temp):
```{r}
print(meanAllYears_dailyTemp)
```

# Accuracy Comparison
Using value of average probability of all years within observed windows for daily temp as threshold and comparing it to chosen probability threshold of 0.5
## 0.5 as Threshold
```{r}
# create a vector of predicted probabilities
preds_05 <- predict(trimmed_daily_reduced_final,
  newdata = select(flow_temp_cond_daily_ice, -ice_presence), # remove real outcomes
  type = "response"
)

# if probability < threshold, ice IS on The Loch
preds_outcome_05 <- ifelse(preds_05 < 0.5,
  1,
  0
)

# transform predictions into factor and set labels
preds_outcome_05 <- factor(preds_outcome_05,
  levels = c(1, 0),
  labels = c("ice", "no ice")
)

# compare observed vs. predicted outcome
tab_05 <- table(flow_temp_cond_daily_ice$ice_presence, preds_outcome_05,
  dnn = c("observed", "predicted")
)

# print results
tab_05

accuracy_05 <- sum(diag(tab_05)) / sum(tab_05)
accuracy_05

# sensitivity
sensitivity_05 <- tab_05[2, 2] / (tab_05[2, 2] + tab_05[2, 1])
sensitivity_05

# specificity
specificity_05<- tab_05[1, 1] / (tab_05[1, 1] + tab_05[1, 2])
specificity_05
```
## Average Probability from daily temp as Threshold:
```{r}
# create a vector of predicted probabilities
preds_avg <- predict(trimmed_daily_reduced_final,
  newdata = select(flow_temp_cond_daily_ice, -ice_presence), # remove real outcomes
  type = "response"
)

# if probability < threshold, ice IS on The Loch
preds_outcome_avg <- ifelse(preds_avg < meanAllYears_dailyTemp,
  1,
  0
)

# transform predictions into factor and set labels
preds_outcome_avg <- factor(preds_outcome_avg,
  levels = c(1, 0),
  labels = c("ice", "no ice")
)

# compare observed vs. predicted outcome
tab_avg <- table(flow_temp_cond_daily_ice$ice_presence, preds_outcome_avg,
  dnn = c("observed", "predicted")
)

# print results
tab_avg

accuracy_avg <- sum(diag(tab_avg)) / sum(tab_avg)
accuracy_avg

# sensitivity
sensitivity_avg <- tab_avg[2, 2] / (tab_avg[2, 2] + tab_avg[2, 1])
sensitivity_avg

# specificity
specificity_avg<- tab_avg[1, 1] / (tab_avg[1, 1] + tab_avg[1, 2])
specificity_avg
```
## Average Probability from cumulative temp as Threshold:
```{r}
# create a vector of predicted probabilities
preds_avg <- predict(trimmed_daily_reduced_final,
  newdata = select(flow_temp_cond_daily_ice, -ice_presence), # remove real outcomes
  type = "response"
)

# if probability < threshold, ice IS on The Loch
preds_outcome_avg <- ifelse(preds_avg < meanAllYears_cumulTemp,
  1,
  0
)

# transform predictions into factor and set labels
preds_outcome_avg <- factor(preds_outcome_avg,
  levels = c(1, 0),
  labels = c("ice", "no ice")
)

# compare observed vs. predicted outcome
tab_avg <- table(flow_temp_cond_daily_ice$ice_presence, preds_outcome_avg,
  dnn = c("observed", "predicted")
)

# print results
tab_avg

accuracy_avg <- sum(diag(tab_avg)) / sum(tab_avg)
accuracy_avg

# sensitivity
sensitivity_avg <- tab_avg[2, 2] / (tab_avg[2, 2] + tab_avg[2, 1])
sensitivity_avg

# specificity
specificity_avg<- tab_avg[1, 1] / (tab_avg[1, 1] + tab_avg[1, 2])
specificity_avg
```
# First day of no ice each year
```{r}
# probabilities_cumulTemp <- predict(daily_cumulTemp_model, type = "response")

preds_test <- predict(daily_cumulTemp_model,
  newdata = select(cumul_Temp_dat_trim_Prob, -ice_presence), # remove real outcomes
  type = "response")
preds_test_factor <- ifelse(preds_test < meanAllYears_cumulTemp,
  1,
  0
) %>%  factor(preds_test_factor, levels = c(1, 0),labels = c("ice", "no ice"))

test_factored_preds <- cumul_Temp_dat_trim_Prob %>% select(waterYear,wy_doy,ice_presence)
test_factored_preds$predicted_ice <- preds_test_factor
```
Pulling out the first day each year when 
```{r}
# Create an empty data frame to store the results
ice_off_dates_predicted_obs <- data.frame()

# Iterate through each unique waterYear
for(year in unique(test_factored_preds$waterYear)) {
  
  # Filter the data for the current year
  year_data <- test_factored_preds %>% filter(waterYear == year)
  
  # Find the first day when ice_presence == "no ice"
  first_no_ice_presence <- year_data %>% 
    filter(ice_presence == "no ice") %>%
    arrange(wy_doy) %>%
    slice(1)
  
  # Find the first day when predicted_ice == "no ice"
  first_no_ice_predicted <- year_data %>% 
    filter(predicted_ice == "no ice") %>%
    arrange(wy_doy) %>%
    slice(1)
  
  # Create a new row with the results
  result_row <- data.frame(
    waterYear = year,
    first_no_ice_presence_doy = first_no_ice_presence$wy_doy,
    first_no_ice_predicted_doy = first_no_ice_predicted$wy_doy
  )
  
  # Append the row to the result data frame
  ice_off_dates_predicted_obs <- bind_rows(ice_off_dates_predicted_obs, result_row)
}

# View the result data frame
View(ice_off_dates_predicted_obs)
```
Find the difference between them
```{r}
ice_off_dates_predicted_obs$difference <- ((ice_off_dates_predicted_obs$first_no_ice_presence_doy)-(ice_off_dates_predicted_obs$first_no_ice_predicted_doy))*-1
print(mean(ice_off_dates_predicted_obs$difference))
# negative means the predicted ice-ff date was EARLIER than the observed
```

# Imputed Error Fix?
```{r}
# pulling out probabilities
probabilities_impute <- predict(trimmed_imputed_reduced_final, type = "response")
# making the probability a binary using the threshold derived from the average of daily temp model probabilities
probability_impute_0_1 <- ifelse(probabilities_impute < meanAllYears_dailyTemp,
  1,
  0
)
# changing the labels of the probabilities
probability_impute_factor <- factor(probability_impute_0_1, levels = c(1, 0),labels = c("ice", "no ice"))
# adding the probabilities to a df of only the observations with imputed temp
imputed_data_trimmed_prob <- imputed_data_trimmed_14_23  %>% select(waterYear,wy_doy,temperature_C_impute) %>% na.omit()
imputed_data_trimmed_prob$predicted_ice <- probability_impute_factor
# adding the probabilities back to the main df

imputed_data_trimmed_14_23_prob_levels <- full_join(imputed_data_trimmed_prob,imputed_data_trimmed_14_23, by = c("waterYear","wy_doy")) %>% select(-temperature_C_impute.x) %>% rename(temperature_C_impute=temperature_C_impute.y)

```

Pulling out the first day each year when ice is "no ice"
```{r}
# Create an empty data frame to store the results
imputed_ice_off_dates_predicted_obs <- data.frame()

# Iterate through each unique waterYear
for(year in unique(imputed_data_trimmed_14_23_prob_levels$waterYear)) {
  
  # Filter the data for the current year
  year_data <- imputed_data_trimmed_14_23_prob_levels %>% filter(waterYear == year)
  
  # Find the first day when ice_presence == "no ice"
  first_no_ice_presence <- year_data %>% 
    filter(ice_presence == "no ice") %>%
    arrange(wy_doy) %>%
    slice(1)
  
  # Find the first day when predicted_ice == "no ice"
  first_no_ice_predicted <- year_data %>% 
    filter(predicted_ice == "no ice") %>%
    arrange(wy_doy) %>%
    slice(1)
  
  # Create a new row with the results
  result_row <- data.frame(
    waterYear = year,
    first_no_ice_presence_doy = first_no_ice_presence$wy_doy,
    first_no_ice_predicted_doy = first_no_ice_predicted$wy_doy
  )
  
  # Append the row to the result data frame
  imputed_ice_off_dates_predicted_obs <- bind_rows(imputed_ice_off_dates_predicted_obs, result_row)
}

# View the result data frame
View(imputed_ice_off_dates_predicted_obs)
```
Find the difference between them
```{r}
imputed_ice_off_dates_predicted_obs$difference <- ((imputed_ice_off_dates_predicted_obs$first_no_ice_presence_doy)-(imputed_ice_off_dates_predicted_obs$first_no_ice_predicted_doy))*-1
print(mean(imputed_ice_off_dates_predicted_obs$difference))
# negative means the predicted ice-ff date was EARLIER than the observed
# it's actually -7.88, 2023 has missing data and prediction is way off
```

# Hindcasting:
```{r}
hindcast_preds <- predict(trimmed_imputed_reduced_final,
  newdata = imputed_data_trimmed,
  type = "response")

# making the probability a binary using the threshold derived from the average of daily temp model probabilities
hindcast_probs_0_1 <- ifelse(hindcast_preds < meanAllYears_dailyTemp,
  1,
  0
)
# changing the labels of the probabilities
hindcast_prob_factor <- factor(hindcast_probs_0_1, levels = c(1, 0),labels = c("ice", "no ice"))

# adding the probabilities to the main df
hindcast_imputed_df <- imputed_data_trimmed  
hindcast_imputed_df$predicted_ice <- hindcast_prob_factor
```

Pulling out the first day each year when ice is "no ice" for hindcasted data
```{r}
# Initialize an empty data frame to store the results
hindcasted_ice_off_dates <- data.frame()

# Iterate through each unique waterYear
for(year in unique(hindcast_imputed_df$waterYear)) {
  
  # Filter the data for the current year where predicted_ice == "no ice"
  year_data <- hindcast_imputed_df %>% 
    filter(waterYear == year, predicted_ice == "no ice") %>%
    arrange(wy_doy)  # Sort by wy_doy to find the first day
  
  # If there is any day where predicted_ice == "no ice"
  if (nrow(year_data) > 0) {
    # Get the first day (earliest day) in that year where predicted_ice == "no ice"
    first_no_ice_day <- year_data %>% slice(1)
    
    # Create a new row with the waterYear and first wy_doy
    result_row <- data.frame(
      waterYear = year,
      first_no_ice_doy = first_no_ice_day$wy_doy
    )
    
    # Append the result_row to the result_df
    hindcasted_ice_off_dates <- bind_rows(hindcasted_ice_off_dates, result_row)
  }
}

# View the result data frame
print(hindcasted_ice_off_dates)
```
Plot them!
```{r}
hindcast_plot <- ggplot(hindcasted_ice_off_dates, aes(x = waterYear, y = first_no_ice_doy)) +
  geom_point() +
  geom_smooth()+
  scale_x_continuous(
    breaks = seq(min(hindcasted_ice_off_dates$waterYear), max(hindcasted_ice_off_dates$waterYear), by = 1))+
  labs(
    title = "Hindcasted Date of Ice-Off 1984-2023",
    x = "Year",
    y = "Water Year DOY of Ice-Off")+
   theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))
hindcast_plot
```

