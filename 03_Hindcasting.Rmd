---
title: "Hindcasting"
output: html_document
date: "2024-11-23"
---

```{r}
# load libraries
library(pacman)
p_load(dplyr,dataRetrieval,lubridate,tidyr,ggplot2,viridis,readxl,imputeTS,tsibble,sjPlot,pROC,gridExtra,broom,gtsummary,zyp)
# This is the file that combines and cleans data:
source("Input_Files/01_Data_Input.R")
```

# Hindcasting:
```{r}
hindcast_preds <- predict(trimmed_imputed_reduced_final,
  newdata = imputed_data_trimmed,
  type = "response")

# making the probability a binary using the threshold derived from the average of daily temp model probabilities
hindcast_probs_0_1 <- ifelse(hindcast_preds < 0.5,
  1,
  0
)
# changing the labels of the probabilities
hindcast_prob_factor <- factor(hindcast_probs_0_1, levels = c(1, 0),labels = c("ice", "no ice"))

# adding the probabilities to the main df
hindcast_imputed_df <- imputed_data_trimmed  
hindcast_imputed_df$predicted_ice <- hindcast_prob_factor
```

Pulling out the first day each year when ice is "no ice" for hindcasted data
```{r}
# Initialize an empty data frame to store the results
hindcasted_ice_off_dates <- data.frame()

# Iterate through each unique waterYear
for(year in unique(hindcast_imputed_df$waterYear)) {
  
  # Filter the data for the current year where predicted_ice == "no ice"
  year_data <- hindcast_imputed_df %>% 
    filter(waterYear == year, predicted_ice == "no ice") %>%
    arrange(wy_doy)  # Sort by wy_doy to find the first day
  
  # If there is any day where predicted_ice == "no ice"
  if (nrow(year_data) > 0) {
    # Get the first day (earliest day) in that year where predicted_ice == "no ice"
    first_no_ice_wy_doy <- year_data %>% slice(1)
    
    # Create a new row with the waterYear and first wy_doy
    result_row <- data.frame(
      waterYear = year,
      first_no_ice_wy_doy = first_no_ice_wy_doy$wy_doy
    )
    
    # Append the result_row to the result_df
    hindcasted_ice_off_dates <- bind_rows(hindcasted_ice_off_dates, result_row)
  }
}

# View the result data frame
print(hindcasted_ice_off_dates)
#write.csv(hindcasted_ice_off_dates, "Input_Files/hindcasted_ice_off_dates.csv")
```
Plot them!
```{r}
hindcast_model <- lm(hindcasted_ice_off_dates$first_no_ice_wy_doy~hindcasted_ice_off_dates$waterYear, data = hindcasted_ice_off_dates)

hindcastMannKen <- MannKendall(hindcasted_dates$first_no_ice_wy_doy)
print(hindcastMannKen)

p_value <- summary(hindcast_model)$coefficients[2, 4]

hindcast_plot <- ggplot(hindcasted_ice_off_dates %>% filter(waterYear<=2021), aes(x = waterYear, y = first_no_ice_wy_doy)) +
  geom_point() +
  scale_x_continuous(
    breaks = seq(min(hindcasted_ice_off_dates$waterYear), max(hindcasted_ice_off_dates$waterYear), by = 1))+
  labs(
    x = "Year",
    y = "Water Year DOY of Ice-Off")+
   theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))

hindcast_plot
#   annotate("text", x = 2019, y = 238, 
#           label = paste("p =", round(p_value, 3)), 
#           size = 3, color = "red", hjust = 0)

ggsave("Figures/hindcast_plot_no_regression.png", dpi=600, width=6, height=4, units="in")
```
As we saw in the analysis, 2021-2023 have a large amount of missing temperature values, so I exclude them from this plot until we can track down the missing temperature observations.


## Pretty Hindcast Plot:
```{r}

labels_y=c(222,232,242,252,262,272,282)

ggplot() +   
  theme_bw() +   
  geom_point(data = hindcasted_ice_off_dates %>% filter(waterYear <= 2012), aes(x = waterYear, y = first_no_ice_wy_doy)) +  
  geom_errorbar(data = obs_ice_off_dates, aes(x = waterYear,y = wy_doy_ice_off,ymin = wy_doy_ice_off - 6,ymax = wy_doy_ice_off),width = .1,position = position_dodge(0.05))+
  geom_point(data = obs_ice_off_dates,inherit.aes = FALSE,aes(x = waterYear, y =wy_doy_ice_off), color = "magenta") +
  # geom_errorbar(data = hindcasted_ice_off_dates %>% filter(waterYear <= 2012),aes(x = waterYear,y = first_no_ice_wy_doy,ymin = first_no_ice_wy_doy-7,ymax = first_no_ice_wy_doy+7),width = .1,     position = position_dodge(0.05)) +
  scale_x_continuous(breaks = seq(min(hindcasted_ice_off_dates$waterYear),     max(hindcasted_ice_off_dates$waterYear),by = 1)) +
  labs(x = "Year", y = "Ice-Off Date") +
  theme(axis.text.x = element_text(angle = 90,vjust = 1,hjust = 1)) +   
  scale_y_continuous(breaks = labels_y,labels = c("10-May","20-May","30-May",       "09-Jun","19-Jun","29-Jun","09-Jul"),limits = c(215, 290))
ggsave("Figures/hindcast_plot_w_error.png", dpi=600, width=6, height=4, units="in")

```


# Hindcasting (Functional Ice-Off):
```{r}
hindcast_preds_func <- predict(trimmed_imputed_reduced_final_func,
  newdata = imputed_data_trimmed_func,
  type = "response")

# making the probability a binary using the threshold derived from the average of daily temp model probabilities
hindcast_probs_0_1_func <- ifelse(hindcast_preds_func < 0.5,
  1,
  0
)
# changing the labels of the probabilities
hindcast_prob_factor_func <- factor(hindcast_probs_0_1_func, levels = c(1, 0),labels = c("ice", "no ice"))

# adding the probabilities to the main df
hindcast_imputed_df_func <- imputed_data_trimmed_func 
hindcast_imputed_df_func$predicted_ice <- hindcast_prob_factor_func
```

Pulling out the first day each year when ice is "no ice" for hindcasted data
```{r}
# Initialize an empty data frame to store the results
hindcasted_ice_off_dates_func <- data.frame()

# Iterate through each unique waterYear
for(year in unique(hindcast_imputed_df_func$waterYear)) {
  
  # Filter the data for the current year where predicted_ice == "no ice"
  year_data <- hindcast_imputed_df_func %>% 
    filter(waterYear == year, predicted_ice == "no ice") %>%
    arrange(wy_doy)  # Sort by wy_doy to find the first day
  
  # If there is any day where predicted_ice == "no ice"
  if (nrow(year_data) > 0) {
    # Get the first day (earliest day) in that year where predicted_ice == "no ice"
    first_no_ice_wy_doy <- year_data %>% slice(1)
    
    # Create a new row with the waterYear and first wy_doy
    result_row_func <- data.frame(
      waterYear = year,
      first_no_ice_wy_doy = first_no_ice_wy_doy$wy_doy
    )
    
    # Append the result_row to the result_df
    hindcasted_ice_off_dates_func <- bind_rows(hindcasted_ice_off_dates_func, result_row_func)
  }
}

# View the result data frame
print(hindcasted_ice_off_dates_func)
```
Plot them!
```{r}
hindcast_plot_func <- ggplot(hindcasted_ice_off_dates_func %>% filter(waterYear<2021), aes(x = waterYear, y = first_no_ice_wy_doy)) +
  geom_point() +
  scale_x_continuous(
    breaks = seq(min(hindcasted_ice_off_dates_func$waterYear), max(hindcasted_ice_off_dates_func$waterYear), by = 1))+
  labs(
    x = "Year",
    y = "Water Year DOY of Ice-Off")+
   theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))
hindcast_plot_func
```

# Wierd Years (really early and really late) - 0% (NOT functional)



```{r}
# 1987 (late): no temperature data until July 7 this year!

ggplot(
  imputed_data_trimmed %>%
    filter(waterYear == 1987),
  aes(x = wy_doy, y = cumulative_dis, group = waterYear)) +
  theme_bw() +
  geom_line() +
  lims(x = c(209, 295), y = c(100, 1500))+
  labs(x="Date", y = "Cumulative Discharge (cms)")

ggplot(
  imputed_data_trimmed %>%
    filter(waterYear == 1987),
  aes(x = wy_doy, y = temperature_C_impute, group = waterYear)) +
  theme_bw() +
  geom_line() +
  lims(x = c(209, 244), y = c(0, 10))
```

```{r}
# 1993 (late): missing almost all temp data

ggplot(
  imputed_data_trimmed %>%
    filter(waterYear == 1993),
  aes(x = wy_doy, y = cumulative_dis, group = waterYear)) +
  theme_bw() +
  geom_line() +
  lims(x = c(209, 295), y = c(100, 1500))+
  labs(x="Date", y = "Cumulative Discharge (cms)")

ggplot(
  imputed_data_trimmed %>%
    filter(waterYear == 1993),
  aes(x = wy_doy, y = temperature_C_impute, group = waterYear)) +
  theme_bw() +
  geom_line() +
  lims(x = c(209, 244), y = c(0, 10))
```

```{r}
# 1995 (late): lots of missing temp data, lots of repeated values

ggplot(
  imputed_data_trimmed %>%
    filter(waterYear == 1995),
  aes(x = wy_doy, y = cumulative_dis, group = waterYear)) +
  theme_bw() +
  geom_line() +
  lims(x = c(209, 295), y = c(100, 1500))+
  labs(x="Date", y = "Cumulative Discharge (cms)")

ggplot(
  imputed_data_trimmed %>%
    filter(waterYear == 1995),
  aes(x = wy_doy, y = temperature_C_impute, group = waterYear)) +
  theme_bw() +
  geom_line() +
  lims(x = c(209, 244), y = c(0, 10))
```

```{r}
# 2000 (early): temperature is wild

ggplot(
  imputed_data_trimmed %>%
    filter(waterYear == 2000),
  aes(x = wy_doy, y = cumulative_dis, group = waterYear)) +
  theme_bw() +
  geom_line() +
  lims(x = c(209, 295), y = c(100, 1500))+
  labs(x="Date", y = "Cumulative Discharge (cms)")

ggplot(
  imputed_data_trimmed %>%
    filter(waterYear == 2000),
  aes(x = wy_doy, y = temperature_C_impute, group = waterYear)) +
  theme_bw() +
  geom_line() +
  lims(x = c(209, 244), y = c(0, 10))
```

```{r}
# 2002 (early): missing temp

ggplot(
  imputed_data_trimmed %>%
    filter(waterYear == 2002),
  aes(x = wy_doy, y = cumulative_dis, group = waterYear)) +
  theme_bw() +
  geom_line() +
  lims(x = c(209, 295), y = c(100, 1500))+
  labs(x="Date", y = "Cumulative Discharge (cms)")

ggplot(
  imputed_data_trimmed %>%
    filter(waterYear == 2002),
  aes(x = wy_doy, y = temperature_C_impute, group = waterYear)) +
  theme_bw() +
  geom_line() +
  lims(x = c(209, 244), y = c(0, 10))
```

```{r}
# 2012 (early): temp is all over the place.

ggplot(
  imputed_data_trimmed %>%
    filter(waterYear == 2012),
  aes(x = wy_doy, y = cumulative_dis, group = waterYear)) +
  theme_bw() +
  geom_line() +
  lims(x = c(209, 295), y = c(100, 1500))+
  labs(x="Date", y = "Cumulative Discharge (cms)")

ggplot(
  imputed_data_trimmed %>%
    filter(waterYear == 2012),
  aes(x = wy_doy, y = temperature_C_impute, group = waterYear)) +
  theme_bw() +
  geom_line() +
  lims(x = c(209, 244), y = c(0, 10))
```